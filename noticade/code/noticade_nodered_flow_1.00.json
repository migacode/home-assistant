[{"id":"f853e486df456711","type":"tab","label":"Noticade 1.00","disabled":false,"info":"","env":[]},{"id":"a669f9e4bb7030b2","type":"comment","z":"f853e486df456711","name":"Noticade 1.00 | Notification Cascade | Benachrichtigungs-Kaskade","info":"","x":280,"y":60,"wires":[]},{"id":"e8834f8041815e21","type":"server-state-changed","z":"f853e486df456711","name":"Ereignis (Zustand)","server":"e5ff3427.b49de8","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.ereignis_zustand","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"triggerId"}],"x":130,"y":140,"wires":[["0c8996e0bf32975e"],[]]},{"id":"0c8996e0bf32975e","type":"function","z":"f853e486df456711","name":"Initialisierung","func":"// ============================================================================\n// Noticade - Benachrichtigungs-Kaskade - NodeRED-Funktionsblock\n// Version: 1.00\n// Datum:   01.03.2025\n// Quelle:  https://github.com/migacode/home-assistant\n// =============================================================================\n// Konfiguration\n// =============================================================================\n// -----------------------------------------------------------------------------\n// Mitteilungstext, der über die HA-Apps ausgegeben wird.\n// -----------------------------------------------------------------------------\nvar noticade_message = 'Achtung! Zuhause ist irgendwas passiert.';\n\n// -----------------------------------------------------------------------------\n// Anzahl Benachrichtigungs-Durchläufe je Empfänger, nach denen mit dem jeweils\n// danach folgenden Empfänger weitergemacht wird.\n// Bei einem Wert von 1 wird direkt nach jeweils nur einem Durchlauf und nach\n// Ablauf der Verzögerungszeit mit dem nächsten Empfänger weitergemacht.\n// -----------------------------------------------------------------------------\nvar noticade_repeat = 3;\n\n// -----------------------------------------------------------------------------\n// Verzögerungszeit zwischen den einzelnen Benachrichtigungen (Sekunden)\n// -----------------------------------------------------------------------------\nvar noticade_delay = 60;\n\n// -----------------------------------------------------------------------------\n// Entitäten der HA-Mobile-Apps\n// -----------------------------\n// Angabe ohne vorangestelltes \"notify.\"\n// ACHTUNG: Anzahl und Position äquivalent zu noticade_phone_id[x].\n// Um keine Nachricht an einen Empfänger zu senden, entsprechenden Eintrag mit\n// 'none' füllen (nicht leer- oder weglassen) => noticade_app_id[x] = 'none';\n// -----------------------------------------------------------------------------\nvar noticade_app_id = [];\nnoticade_app_id[0] = 'none';\nnoticade_app_id[1] = 'mobile_app_mobiltelefon_1';\nnoticade_app_id[2] = 'mobile_app_mobiltelefon_2';\n\n// -----------------------------------------------------------------------------\n// Entitäten der Telefon-Anruf-Vorlagen aus der Integration AVM Fritz!SmartHome\n// -----------------------------------------------------------------------------\n// Angabe ohne vorangestelltes \"button.\"\n// ACHTUNG: Anzahl und Position äquivalent zu noticade_app_id[x].\n// Um einen Empfänger nicht anzurufen, den entsprechenden Eintrag mit 'none'\n// füllen (nicht leer- oder weglassen) => noticade_phone_id[x] = 'none';\n// -----------------------------------------------------------------------------\nvar noticade_phone_id = [];\nnoticade_phone_id[0] = 'anruf_haustelefon_1';\nnoticade_phone_id[1] = 'anruf_mobiltelefon_1';\nnoticade_phone_id[2] = 'anruf_mobiltelefon_2';\n\n// =============================================================================\n// Ende der Konfiguration - ab hier keine Änderungen mehr durchführen!\n// =============================================================================\n// =============================================================================\n// Speichern der Variablen\n// =============================================================================\n// -----------------------------------------------------------------------------\n// Entität des zu überwachenden Zustands (automatisch aus triggerndem Node)\n// HINWEIS: Die Kaskade läuft nur solange der Zustand dieser Entität \"on\" ist.\n// -----------------------------------------------------------------------------\nvar noticade_trigger_id = msg.payload;\nglobal.set(\"noticade_trigger_id\", noticade_trigger_id);\n// -----------------------------------------------------------------------------\n// Mitteilungstext\n// -----------------------------------------------------------------------------\nglobal.set(\"noticade_message\", noticade_message);\n// -----------------------------------------------------------------------------\n// Anzahl Benachrichtigungs-Durchläufe je Empfänger\n// -----------------------------------------------------------------------------\nglobal.set(\"noticade_repeat\", noticade_repeat);\n// -----------------------------------------------------------------------------\n// Verzögerungszeit zwischen den einzelnen Benachrichtigungen\n// -----------------------------------------------------------------------------\nglobal.set(\"noticade_delay\", noticade_delay);\n// -----------------------------------------------------------------------------\n// Maximaler Empfänger-Index\n// -----------------------------------------------------------------------------\nvar noticade_max_idx = noticade_app_id.length - 1;\nglobal.set(\"noticade_max_idx\", noticade_max_idx);\n// -----------------------------------------------------------------------------\n// Entitäten der HA-Mobile-Apps\n// -----------------------------------------------------------------------------\nfor (var i = 0; i <= noticade_max_idx; i++) {\n  global.set(\"noticade_app_id_\" + i, noticade_app_id[i]);\n}\n// -----------------------------------------------------------------------------\n// Entitäten der Telefon-Anruf-Vorlagen\n// -----------------------------------------------------------------------------\nfor (var i = 0; i <= noticade_max_idx; i++) {\n  global.set(\"noticade_phone_id_\" + i, noticade_phone_id[i]);\n}\n// -----------------------------------------------------------------------------\n// Index des aktuellen Empfängers\n// -----------------------------------------------------------------------------\nvar noticade_index = 0;\nglobal.set(\"noticade_index\", noticade_index);\n// -----------------------------------------------------------------------------\n// Nummer des aktuellen Durchlaufs je Empfänger\n// -----------------------------------------------------------------------------\nvar noticade_loop = 0;\nglobal.set(\"noticade_loop\", noticade_loop);\n\n// =============================================================================\n// Die Benachrichtigungs-Kaskade anstoßen\n// =============================================================================\nmsg.payload = [];\nvar newMsg = {};\nnewMsg.payload = {\n  noticade_trigger_id: noticade_trigger_id\n}\nnode.send(newMsg);\nnode.done();\nreturn null;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":140,"wires":[["6eca00373f8ebbc0"]]},{"id":"913e11d9397f761e","type":"function","z":"f853e486df456711","name":"Looper","func":"// ============================================================================\n// Noticade - Looper\n// Version: 1.00\n// Datum:   28.02.2025\n// -----------------------------------------------------------------------------\n// Ermittelt die für den laufenden Empfänger konfigurierten Einstellungen,\n// löst die entsprechenden Aktionen aus und passt die laufenden Zähler an.\n// =============================================================================\n// ACHTUNG: In diesem Script keine Änderungen durchführen, wenn Du nicht genau\n// weißt was Du tust - die Konfiguration von Noticade erfolgt ausschließlich\n// in dem Node \"Initialisierung\". ;)\n// =============================================================================\n// -----------------------------------------------------------------------------\n// In dem Node Initalisierung gesetzte Variablen einlesen\n// -----------------------------------------------------------------------------\nvar noticade_trigger_id = global.get(\"noticade_trigger_id\");\nvar noticade_message    = global.get(\"noticade_message\");\nvar noticade_repeat     = parseInt(global.get(\"noticade_repeat\"));\nvar noticade_delay      = parseInt(global.get(\"noticade_delay\"));\nvar noticade_index      = parseInt(global.get(\"noticade_index\"));\nvar noticade_max_idx    = parseInt(global.get(\"noticade_max_idx\"));\nvar noticade_loop       = parseInt(global.get(\"noticade_loop\"));\n\n// -----------------------------------------------------------------------------\n// Aktuelle Entitäten für Ausgabe-Pfade einlesen (VOR der Erhöhung der Zähler)\n// -----------------------------------------------------------------------------\nvar current_ha_app_id = global.get(\"noticade_app_id_\" + noticade_index);\nvar current_phone_id  = global.get(\"noticade_phone_id_\" + noticade_index);\n\n// -----------------------------------------------------------------------------\n// Durchlauf-Zähler erhöhen und bei Maximalwert zum nächsten Empfänger springen\n// -----------------------------------------------------------------------------\nif (noticade_loop < noticade_repeat)\n{\n  noticade_loop += 1;\n}\nelse\n{\n  noticade_loop = 1;\n  // ---------------------------------------------------------------------------\n  // Index des Empfängers erhöhen bzw. zurücksetzen\n  // ---------------------------------------------------------------------------\n  if (noticade_index < noticade_max_idx)\n  {\n    noticade_index += 1;\n  }\n  else\n  {\n    noticade_index = 0;\n  }\n  global.set(\"noticade_index\", noticade_index);\n  // Durchgangs-Zähler zurücksetzen\n}\nglobal.set(\"noticade_loop\", noticade_loop);\n\n// -----------------------------------------------------------------------------\n// Neuen Payload zusammenbauen\n// -----------------------------------------------------------------------------\nmsg.payload = [];\nvar newMsg = {};\nnewMsg.payload = {\n  // noticade_index: noticade_index,   // Nur zum Testen\n  // noticade_loop: noticade_loop,     // Nur zum Testen\n  noticade_trigger_id: noticade_trigger_id,\n  noticade_message: noticade_message,\n  noticade_delay: noticade_delay,\n  noticade_ha_app_id: current_ha_app_id,\n  noticade_phone_id: current_phone_id\n}\n\n// -----------------------------------------------------------------------------\n// Ausgaben anstoßen\n// (Ausgang 3 dient nur zur Weiterleitung / Fortführung des Flows)\n// -----------------------------------------------------------------------------\nif (current_ha_app_id != 'undefined' && current_phone_id != 'undefined' &&\n    current_ha_app_id != null && current_phone_id != null)\n{\n  // Ausgabe an HA-Apps und Telefon-Anruf (Ausgang 1, 2 und 3)\n  if (current_ha_app_id.toLowerCase() != 'none' && current_phone_id.toLowerCase() != 'none')\n  {\n    node.send([newMsg, newMsg, newMsg]); // asynchron\n    node.done();\n    // return [newMsg, newMsg, newMsg]; // synchron\n  }\n  else\n  {\n    // Ausgabe an HA-Apps und kein Telefon-Anruf (nur Ausgang 1 und 3)\n    if (current_ha_app_id.toLowerCase() != 'none' && current_phone_id.toLowerCase() == 'none')\n    {\n      node.send([newMsg, null, newMsg]); // asynchron\n      node.done();\n      // return [newMsg, null, newMsg]; // synchron\n    } \n    // Keine Ausgabe an HA-Apps, nur Telefon-Anruf (nur Ausgang 2 und 3)\n    if (current_ha_app_id.toLowerCase() == 'none' && current_phone_id.toLowerCase() != 'none')\n    {\n      node.send([null, newMsg, newMsg]); // asynchron\n      node.done();\n      // return [null, newMsg, newMsg]; // synchron\n    }\n  }\n}\nelse\n{\n  // ---------------------------------------------------------------------------\n  // Wenn keine gültigen Informationen vorliegen, keine Ausgabe und kein Anruf\n  // ---------------------------------------------------------------------------\n  node.send([null, null, newMsg]); // asynchron\n  node.done();\n  // return [null, null, newMsg]; // synchron\n}\nreturn null;","outputs":3,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":220,"wires":[["7a7c94969de47800","7da65a8e38c5b273"],["f26fd47751b2bf3c"],["61d0edb394b2e1a5"]]},{"id":"3a8104e8c8fbc6b5","type":"debug","z":"f853e486df456711","d":true,"name":"Ende","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":770,"y":100,"wires":[]},{"id":"6eca00373f8ebbc0","type":"api-current-state","z":"f853e486df456711","name":"Zustand prüfen","server":"e5ff3427.b49de8","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"{{payload.noticade_trigger_id}}","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":560,"y":140,"wires":[["3a8104e8c8fbc6b5"],["913e11d9397f761e"]]},{"id":"42ce6913b28acd74","type":"delay","z":"f853e486df456711","name":"Verzögerung","pauseType":"delayv","timeout":"30","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":210,"y":300,"wires":[["6eca00373f8ebbc0"]]},{"id":"f26fd47751b2bf3c","type":"api-call-service","z":"f853e486df456711","name":"Telefon-Anruf","server":"e5ff3427.b49de8","version":5,"debugenabled":false,"domain":"button","service":"press","areaId":[],"deviceId":[],"entityId":["button.{{payload.noticade_phone_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":790,"y":280,"wires":[[]]},{"id":"7a7c94969de47800","type":"api-call-service","z":"f853e486df456711","name":"Text-Nachricht an HA-App","server":"e5ff3427.b49de8","version":5,"debugenabled":false,"domain":"notify","service":"{{payload.noticade_ha_app_id}}","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"message\" : payload.noticade_message }","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":830,"y":160,"wires":[[]]},{"id":"7da65a8e38c5b273","type":"api-call-service","z":"f853e486df456711","name":"Sprach-Nachricht an HA-App","server":"e5ff3427.b49de8","version":5,"debugenabled":false,"domain":"notify","service":"{{payload.noticade_ha_app_id}}","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"message\": \"TTS\", \"data\": { \"ttl\": 0, \"priority\": \"high\", \"media_stream\": \"alarm_stream\", \"tts_text\": \"{{payload.noticade_message}}\" } }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":220,"wires":[[]]},{"id":"61d0edb394b2e1a5","type":"change","z":"f853e486df456711","name":"Verzögerungsdauer umwandeln","rules":[{"t":"set","p":"delay","pt":"flow","to":"payload.noticade_delay * 1000","tot":"jsonata"},{"t":"set","p":"delay","pt":"msg","to":"delay","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":510,"y":300,"wires":[["42ce6913b28acd74"]]},{"id":"e5ff3427.b49de8","type":"server","name":"Home Assistant","addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"","connectionDelay":false,"cacheJson":false,"heartbeat":false,"heartbeatInterval":"","statusSeparator":"","enableGlobalContextStore":false}]