[{"id":"9e89b60452aac465","type":"tab","label":"LeckDet 1.00","disabled":false,"info":"","env":[]},{"id":"b70a8a223ed5911e","type":"api-call-service","z":"9e89b60452aac465","name":"Zwischen-Zählerstand 1 speichern","server":"e5ff3427.b49de8","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.leckage_detektiv_zahlerstand_1"],"data":"{\"value\":leckdet_stand_aktuell}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":600,"wires":[["2503cd4e97a3ba2c"]]},{"id":"6fbc604b6fb4aaa9","type":"inject","z":"9e89b60452aac465","name":"Aktuellen Zählerstand anzeigen","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":190,"y":400,"wires":[["effd26a1b67acdce"]]},{"id":"effd26a1b67acdce","type":"api-current-state","z":"9e89b60452aac465","name":"Aktuellen Zählerstand einlesen","server":"e5ff3427.b49de8","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"is","entity_id":"sensor.watermeter_raw","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"leckdet_stand_aktuell","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":510,"y":400,"wires":[["58351748c713f99d"]]},{"id":"58351748c713f99d","type":"debug","z":"9e89b60452aac465","name":"Aktueller Zählerstand","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"leckdet_stand_aktuell","targetType":"msg","statusVal":"","statusType":"auto","x":800,"y":400,"wires":[]},{"id":"2503cd4e97a3ba2c","type":"debug","z":"9e89b60452aac465","name":"Zwischen-Zählerstand 1","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"leckdet_stand_aktuell","targetType":"msg","statusVal":"","statusType":"auto","x":1150,"y":600,"wires":[]},{"id":"f1e853e1da4aaae2","type":"comment","z":"9e89b60452aac465","name":"Werte anzeigen","info":"","x":120,"y":340,"wires":[]},{"id":"6f7dec5b515e164e","type":"comment","z":"9e89b60452aac465","name":"Automatisierungen","info":"","x":130,"y":540,"wires":[]},{"id":"c3a5c4322953f67e","type":"comment","z":"9e89b60452aac465","name":"LeckDet 1.00 | Leckage-Detektiv","info":"","x":170,"y":60,"wires":[]},{"id":"db08dea2eb862b67","type":"comment","z":"9e89b60452aac465","name":"HINWEISE \\n Benötigt werden folgende Helfer in Home Assistant: \\n - input_number.leckage_detektiv_zahlerstand_1 \\n - input_number.leckage_detektiv_zahlerstand_2 \\n - input_number.leckage_detektiv_zahlerstand_3 \\n sowie \\n - input_boolean.leckage_detektiv_leck_erkannt","info":"","x":230,"y":180,"wires":[]},{"id":"0da99f47073952b1","type":"inject","z":"9e89b60452aac465","name":"Erste Messung um 03:00 Uhr","props":[],"repeat":"","crontab":"00 03 * * *","once":false,"onceDelay":0.1,"topic":"","x":190,"y":600,"wires":[["3da098126cd77363"]]},{"id":"b6f04e9662a96c15","type":"debug","z":"9e89b60452aac465","name":"Zwischen-Zählerstände","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"{\"Zwischen-Zählerstände\":$join([\"Zähler 1 : \",$string(leckdet_stand_1.daten.state),\" | Zähler 2 : \",$string(leckdet_stand_2.daten.state),\" | Zähler 3 : \",$string(leckdet_stand_3.daten.state)])}","targetType":"jsonata","statusVal":"","statusType":"auto","x":810,"y":460,"wires":[]},{"id":"b31f3015261539d5","type":"api-call-service","z":"9e89b60452aac465","name":"Zwischen-Zählerstand 2 speichern","server":"e5ff3427.b49de8","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.leckage_detektiv_zahlerstand_2"],"data":"{\"value\":leckdet_stand_aktuell}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":660,"wires":[["84b139029548ed9c"]]},{"id":"84b139029548ed9c","type":"debug","z":"9e89b60452aac465","name":"Zwischen-Zählerstand 2","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"leckdet_stand_aktuell","targetType":"msg","statusVal":"","statusType":"auto","x":1150,"y":660,"wires":[]},{"id":"39b06a057712e21a","type":"inject","z":"9e89b60452aac465","name":"Zweite Messung um 03:15 Uhr","props":[],"repeat":"","crontab":"15 03 * * *","once":false,"onceDelay":0.1,"topic":"","x":190,"y":660,"wires":[["1098fdee27852741"]]},{"id":"653dc07004a2eea9","type":"api-call-service","z":"9e89b60452aac465","name":"Zwischen-Zählerstand 3 speichern","server":"e5ff3427.b49de8","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.leckage_detektiv_zahlerstand_3"],"data":"{\"value\":leckdet_stand_aktuell}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":720,"wires":[["335ae6327fcc177d"]]},{"id":"335ae6327fcc177d","type":"debug","z":"9e89b60452aac465","name":"Zwischen-Zählerstand 3","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"leckdet_stand_aktuell","targetType":"msg","statusVal":"","statusType":"auto","x":1150,"y":720,"wires":[]},{"id":"731f46b13bc62b79","type":"inject","z":"9e89b60452aac465","name":"Dritte Messung um 03:30 Uhr","props":[],"repeat":"","crontab":"30 03 * * *","once":false,"onceDelay":0.1,"topic":"","x":190,"y":720,"wires":[["c598c067e965b3b6"]]},{"id":"844bcf5ed51722c4","type":"inject","z":"9e89b60452aac465","name":"Vierte Messung um 03:45 Uhr","props":[],"repeat":"","crontab":"45 03 * * *","once":false,"onceDelay":0.1,"topic":"","x":190,"y":780,"wires":[["084a5805b4c00e70"]]},{"id":"81b9ecba5fc3821e","type":"inject","z":"9e89b60452aac465","name":"Zwischen-Zählerstände anzeigen","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":190,"y":460,"wires":[["68a48ca9c5df091a"]]},{"id":"68a48ca9c5df091a","type":"api-current-state","z":"9e89b60452aac465","name":"Zwischen-Zählerstände einlesen","server":"e5ff3427.b49de8","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"is","entity_id":"input_number.leckage_detektiv_zahlerstand_1","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"leckdet_stand_1","propertyType":"msg","value":"{\"daten\":$entities(\"input_number.leckage_detektiv_zahlerstand_1\")}","valueType":"jsonata"},{"property":"leckdet_stand_2","propertyType":"msg","value":"{\"daten\":$entities(\"input_number.leckage_detektiv_zahlerstand_2\")}","valueType":"jsonata"},{"property":"leckdet_stand_3","propertyType":"msg","value":"{\"daten\":$entities(\"input_number.leckage_detektiv_zahlerstand_3\")}","valueType":"jsonata"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":510,"y":460,"wires":[["b6f04e9662a96c15"]]},{"id":"3da098126cd77363","type":"api-current-state","z":"9e89b60452aac465","name":"Aktuellen Zählerstand einlesen","server":"e5ff3427.b49de8","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"is","entity_id":"sensor.watermeter_raw","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"leckdet_stand_aktuell","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":510,"y":600,"wires":[["b70a8a223ed5911e"]]},{"id":"1098fdee27852741","type":"api-current-state","z":"9e89b60452aac465","name":"Aktuellen Zählerstand einlesen","server":"e5ff3427.b49de8","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"is","entity_id":"sensor.watermeter_raw","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"leckdet_stand_aktuell","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":510,"y":660,"wires":[["b31f3015261539d5"]]},{"id":"c598c067e965b3b6","type":"api-current-state","z":"9e89b60452aac465","name":"Aktuellen Zählerstand einlesen","server":"e5ff3427.b49de8","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"is","entity_id":"sensor.watermeter_raw","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"leckdet_stand_aktuell","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":510,"y":720,"wires":[["653dc07004a2eea9"]]},{"id":"084a5805b4c00e70","type":"api-current-state","z":"9e89b60452aac465","name":"Aktuellen Zählerstand einlesen","server":"e5ff3427.b49de8","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"is","entity_id":"sensor.watermeter_raw","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"leckdet_stand_aktuell","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":510,"y":780,"wires":[["9b57a417e6d85a9b"]]},{"id":"9b57a417e6d85a9b","type":"api-current-state","z":"9e89b60452aac465","name":"Zwischen-Zählerstände einlesen","server":"e5ff3427.b49de8","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"is","entity_id":"input_number.leckage_detektiv_zahlerstand_1","state_type":"num","blockInputOverrides":false,"outputProperties":[{"property":"leckdet_stand_1","propertyType":"msg","value":"{\"daten\":$entities(\"input_number.leckage_detektiv_zahlerstand_1\")}","valueType":"jsonata"},{"property":"leckdet_stand_2","propertyType":"msg","value":"{\"daten\":$entities(\"input_number.leckage_detektiv_zahlerstand_2\")}","valueType":"jsonata"},{"property":"leckdet_stand_3","propertyType":"msg","value":"{\"daten\":$entities(\"input_number.leckage_detektiv_zahlerstand_3\")}","valueType":"jsonata"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":830,"y":780,"wires":[["5e2f624dbacc844d"]]},{"id":"5e2f624dbacc844d","type":"function","z":"9e89b60452aac465","name":"Auf Leckage prüfen","func":"// ============================================================================\n// Leckage Detektiv - Erkennung unerwünschter Verbräuche durch Rohrlecks o.a.\n// Version: 1.00\n// Datum:   25.01.2025\n// Quelle:  https://github.com/migacode/home-assistant\n// =============================================================================\n// Konfiguration\n// =============================================================================\n// -----------------------------------------------------------------------------\n// Mindestdifferenz zwischen Zählerständen, ab der eine Leckage erkannt wird -\n// kann dazu genutzt werden, permanente gewollte Entnahmen zu berücksichtigen\n// -----------------------------------------------------------------------------\nvar leck_min_diff = 1;\n// =============================================================================\n// Initialisierung\n// =============================================================================\n// -----------------------------------------------------------------------------\n// Alle zuvor ermittelten und zwischengespeicherten Zählerstände einlesen\n// -----------------------------------------------------------------------------\nvar leckdet_aktuell = parseFloat(msg.leckdet_stand_aktuell);\nvar leckdet_stand_1 = parseFloat(msg.leckdet_stand_1.daten.state);\nvar leckdet_stand_2 = parseFloat(msg.leckdet_stand_2.daten.state);\nvar leckdet_stand_3 = parseFloat(msg.leckdet_stand_3.daten.state);\n// =============================================================================\n// Here we go ...\n// =============================================================================\n// -----------------------------------------------------------------------------\n// Alten Payload löschen, um keine Daten daraus mit weiterzuleiten\n// -----------------------------------------------------------------------------\nmsg.payload = [];\nvar output = {};\n// -----------------------------------------------------------------------------\n// Ausgabe erzeugen (nur zum testen, nicht relevant für die Funktion selbst)\n// -----------------------------------------------------------------------------\noutput.payload = {\n  msg: \"Aktuell : \" + leckdet_aktuell + \", Zähler 1 : \" + leckdet_stand_1 + \", Zähler 2 : \" + leckdet_stand_2 + \", Zähler 3 : \" + leckdet_stand_3\n}\n// -----------------------------------------------------------------------------\n// Wenn bei allen Messungen größere Verlustmengen ermittelt wurden als erlaubt\n// existiert vermutlich eine Leckage - in dem Fall Ausgang 1 triggern ...\n// -----------------------------------------------------------------------------\nif (Math.abs(leckdet_stand_2 - leckdet_stand_1) >= leck_min_diff &&\n    Math.abs(leckdet_stand_3 - leckdet_stand_2) >= leck_min_diff &&\n    Math.abs(leckdet_aktuell - leckdet_stand_3) >= leck_min_diff)\n{\n  node.send([output, null]); // asynchron\n  node.done();\n  // return [output, null]; // synchron\n}\n// -----------------------------------------------------------------------------\n// ... sonst Ausgang 2 triggern\n// -----------------------------------------------------------------------------\nelse\n{\n  node.send([null, output]); // asynchron\n  node.done();\n  // return [null, output]; // synchron\n}\n// -----------------------------------------------------------------------------\n// Skript OHNE Rückmeldung beenden (Daten wurden schon mit node.send gesendet)\n// -----------------------------------------------------------------------------\nreturn null;","outputs":2,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":880,"wires":[["32522947e238429f"],["cf136af9a3dea693"]]},{"id":"fb8d1f3d6426a669","type":"debug","z":"9e89b60452aac465","name":"Leckage entdeckt","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":930,"y":860,"wires":[]},{"id":"d436730ce6db115d","type":"debug","z":"9e89b60452aac465","name":"Keine Leckage entdeckt","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":950,"y":900,"wires":[]},{"id":"32522947e238429f","type":"api-call-service","z":"9e89b60452aac465","name":"Leck erkannt AN","server":"e5ff3427.b49de8","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.leckage_detektiv_leck_erkannt"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":700,"y":860,"wires":[["fb8d1f3d6426a669"]]},{"id":"cf136af9a3dea693","type":"api-call-service","z":"9e89b60452aac465","name":"Leck erkannt AUS","server":"e5ff3427.b49de8","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.leckage_detektiv_leck_erkannt"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":710,"y":900,"wires":[["d436730ce6db115d"]]},{"id":"e5ff3427.b49de8","type":"server","name":"Home Assistant","addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"","connectionDelay":false,"cacheJson":false,"heartbeat":false,"heartbeatInterval":"","statusSeparator":"","enableGlobalContextStore":false}]