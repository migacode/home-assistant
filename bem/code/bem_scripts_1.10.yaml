# =============================================================================
# Behälter-Entnahme-Messung (BEM) - Scripts
# Einbindung in der configuration.yaml unter dem Bereich "script:"
# Version: 1.10
# -----------------------------------------------------------------------------
# ACHTUNG: 'sensor.behaelter_fuellstand_aktuell' durch die Entitäts-ID des
#          eigenen tatsächlichen Sensors ersetzen.
# =============================================================================
# -----------------------------------------------------------------------------
# Entnahme Beginn
# -----------------------------------------------------------------------------
  bem_entnahme_beginn:
    alias: BEM - Entnahme Beginn
    description: ""
    sequence:
      - service: input_number.set_value
        continue_on_error: true
        target:
          entity_id: input_number.bem_stand_bei_beginn_letzter_entnahme
        data:
          value: "{{ states('sensor.behaelter_fuellstand_aktuell') | float }}"
      - service: input_boolean.turn_on
        continue_on_error: true
        target:
          entity_id: input_boolean.bem_entnahme_status
# -----------------------------------------------------------------------------
# Entnahme Ende
# -----------------------------------------------------------------------------
  bem_entnahme_ende:
    alias: BEM - Entnahme Ende
    variables:
      letzte_gesamt: "{{ states('input_number.bem_entnahme_gesamt') | float }}"
      stand_beginn: "{{ states('input_number.bem_stand_bei_beginn_letzter_entnahme') | float }}"
      stand_ende: "{{ states('sensor.behaelter_fuellstand_aktuell') | float }}"
    description: ""
    sequence:
      - service: input_boolean.turn_off
        continue_on_error: true
        target:
          entity_id: input_boolean.bem_entnahme_status
      - service: input_number.set_value
        continue_on_error: true
        target:
          entity_id: input_number.bem_entnahme_letzte
        data:
          value: "{{ (stand_beginn - stand_ende) | float }}"
      - service: input_number.set_value
        continue_on_error: true
        target:
          entity_id: input_number.bem_entnahme_gesamt
        data:
          value: "{{ (letzte_gesamt + stand_beginn - stand_ende) | float }}"
